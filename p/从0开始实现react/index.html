<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Job Interview tips'><title>ä»0å¼€å§‹å®ç°React</title>

<link rel='canonical' href='https://observerzq.github.io/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/'>

<link rel="stylesheet" href="/ObzerverZQ.github.io/scss/style.min.css"><meta property='og:title' content='ä»0å¼€å§‹å®ç°React'>
<meta property='og:description' content='Job Interview tips'>
<meta property='og:url' content='https://observerzq.github.io/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/'>
<meta property='og:site_name' content='Observerçš„å°å®¶'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='React' /><meta property='article:published_time' content='2021-03-30T12:20:26&#43;08:00'/><meta property='article:modified_time' content='2021-03-30T12:20:26&#43;08:00'/><meta property='og:image' content='https://observerzq.github.io/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/react.jpeg' />
<meta name="twitter:title" content="ä»0å¼€å§‹å®ç°React">
<meta name="twitter:description" content="Job Interview tips"><meta name="twitter:card" content="">
	<meta name="twitter:image" content='https://observerzq.github.io/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/react.jpeg' />
    </head>
    <body class="">
        <div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar">
            <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            <figure class="site-avatar">
                
                    
                    
                    
                        
                        <img src="/ObzerverZQ.github.io/img/avatar_huf4d83bafa5838b1714e814874f4f8037_84351_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                

                
                    <span class="emoji">ğŸ‘©ğŸ»â€ğŸ’»</span>
                
            </figure>
        
        <h1 class="site-name"><a href="https://observerzq.github.io/ObzerverZQ.github.io/">Observerçš„å°å®¶</a></h1>
        <h2 class="site-description">ä¸€ä¸ªå‰ç«¯å°ç™½.</h2>
    </header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/ObzerverZQ.github.io/'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/ObzerverZQ.github.io/about'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/ObzerverZQ.github.io/post'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>Posts</span>
            </a>
        </li>
        
        

        <li >
            <a href='/ObzerverZQ.github.io/archives'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/ObzerverZQ.github.io/search'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
    </ol>
</aside>

            <main class="main full-width">
    <div id="article-toolbar">
        <a href="https://observerzq.github.io/ObzerverZQ.github.io/" class="back-home">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



            <span>Back</span>
        </a>
    </div>

    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <img srcset="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/react_hu4014157c127633b5f677ff85eb79e346_173734_1024x0_resize_q75_box.jpeg 1024w, /ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/react_hu4014157c127633b5f677ff85eb79e346_173734_2000x0_resize_q75_box.jpeg 2000w"
                    src="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/react_hu4014157c127633b5f677ff85eb79e346_173734_2000x0_resize_q75_box.jpeg" width="1200" height="638" loading="lazy"
                    alt="Featured image of post ä»0å¼€å§‹å®ç°React" />
            
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/ObzerverZQ.github.io/categories/%E6%A1%86%E6%9E%B6%E5%8E%9F%E7%90%86/" 
                    class="color-tag"
                    data-image="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/react_hu4014157c127633b5f677ff85eb79e346_173734_20x20_fill_q75_box_smart1.jpeg" 
                    data-key="" 
                    data-hash="md5-smuMxL6qzvl&#43;OUxTfuxHUg==">
                    æ¡†æ¶åŸç†
                </a>
            
        
    </header>
    

    <h2 class="article-title">
        <a href="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/">ä»0å¼€å§‹å®ç°React</a>
    </h2>

    
    <h3 class="article-subtitle">
        Job Interview tips
    </h3>
    <footer class="article-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--published">Mar 30, 2021</time>
    </footer></div>
</header>

    <section class="article-content">
    <p>å‚è€ƒï¼šhttps://pomb.us/build-your-own-react/
åŸºäºReact 16.8å®ç°ï¼Œå› è€Œå¯ä»¥ä½¿ç”¨hookï¼Œä¸å†ä¹¦å†™ä½¿ç”¨è¿‡å»çš„classç›¸å…³çš„ä»£ç ã€‚</p>
<p>å®ç°Reactçš„åŸºæœ¬æ€è·¯å¦‚ä¸‹ï¼š
Step I: The createElement Function  ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºèŠ‚ç‚¹
Step II: The render Function    ç¬¬äºŒæ­¥ï¼šæ¸²æŸ“
Step III: Concurrent Mode     ç¬¬ä¸‰æ­¥ï¼šconcurrentæ¨¡å¼
Step IV: Fibers               ç¬¬å››æ­¥ï¼šFiberâ€œçº¤ç»´â€
Step V: Render and Commit Phases  ç¬¬äº”æ­¥ï¼š æ¸²æŸ“å’ŒCommité˜¶æ®µ
Step VI: Reconciliation           ç¬¬å…­æ­¥ï¼šè°ƒå’Œ
Step VII: Function Components   ç¬¬ä¸ƒæ­¥ï¼šå‡½æ•°ç»„ä»¶
Step VIII: Hooks                ç¬¬å…«æ­¥ï¼šHooks</p>
<h1 id="ç¬¬0æ­¥å›é¡¾">ç¬¬0æ­¥ï¼šå›é¡¾</h1>
<p>ä¸‹é¢æ˜¯æœ€ç®€å•çš„å‡ è¡ŒReactä»£ç ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">h1</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
<span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">)</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="c1">// æŠŠelementæ’å…¥åˆ°é¡µé¢çš„DOMèŠ‚ç‚¹containerä¸­
</span></code></pre></div><p>ç¬¬ä¸€è¡Œä»£ç æ›¿æ¢æˆvanillaï¼ˆé¦™è‰ï¼Ÿï¼‰JSä»£ç ï¼Œå˜åŒ–å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// JSX é€šè¿‡Babelç¼–è¯‘æˆJS
</span><span class="c1">// ä¸€èˆ¬è½¬æ¢è¿‡ç¨‹éƒ½å¾ˆç®€å•ï¼šè°ƒç”¨createElementæŠŠtagå†…çš„ä»£ç æ›¿æ¢æ‰ï¼Œä¼ å…¥tagåï¼Œå±æ€§å’Œå­èŠ‚ç‚¹ä½œä¸ºå‚æ•°
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">h1</span> <span class="nx">title</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="o">&lt;</span><span class="err">/h1&gt; </span>
<span class="c1">// ========transformation=========
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span>
  <span class="s2">&#34;h1&#34;</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span> <span class="p">},</span>
  <span class="s2">&#34;Hello&#34;</span>
<span class="p">)</span>
<span class="c1">// React.createElement æ ¹æ®å…¥å‚è¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚ä¸­é—´è¿˜æœ‰ä¸€äº›æ ¡éªŒã€‚
</span><span class="c1">// æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºå‡½æ•°æœ€ç»ˆçš„è¾“å‡ºã€‚
</span><span class="c1">// è¿™å°±æ˜¯Reactä¸­ä¸€ä¸ªelement objectï¼ŒåŒ…å«typeå’Œpropsä¸¤ä¸ªå­—æ®µï¼ˆç›®å‰æˆ‘ä»¬åªå…³æ³¨è¿™ä¸¤ä¸ªå±æ€§ï¼‰
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// typeæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æˆ‘ä»¬æƒ³è¦åˆ›å»ºçš„DOMèŠ‚ç‚¹çš„ç±»å‹ï¼Œå’Œdocument.createElementæ–¹æ³•ä¸­çš„tagNameæ˜¯ä¸€æ ·çš„ã€‚typeä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªç•™åˆ°ç¬¬7æ­¥å†ä½œè®²è§£ã€‚
</span><span class="c1"></span>    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;h1&#39;</span><span class="p">,</span>
    <span class="c1">// propsæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåŒ…å«æ‰€æœ‰JSXå±æ€§çš„é”®å€¼å¯¹ã€‚å®ƒè¿˜åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§childrenã€‚ 
</span><span class="c1"></span>    <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
        <span class="c1">// childrenåœ¨è¿™é‡Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯å®ƒé€šå¸¸æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å¤šä¸ªelementã€‚è¿™ä¹Ÿæ˜¯elementsä¹Ÿæ˜¯æ ‘çš„åŸå› ã€‚
</span><span class="c1"></span>        <span class="nx">children</span><span class="o">:</span> <span class="s1">&#39;Hello&#39;</span> 
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div><p>ç„¶åè¿˜æœ‰ç¬¬3è¡Œä»£ç ï¼Œè¿™æ˜¯Reactæ¸²æŸ“/ä¿®æ”¹DOMçš„åœ°æ–¹ï¼Œç°åœ¨ç”±æˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™ä¸ªæ›´æ–°ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ ¹æ®React elementçš„typeå»åˆ›å»ºä¸€ä¸ªDOMèŠ‚ç‚¹nodeï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯h1ã€‚
ç„¶åæˆ‘ä»¬å°†elementæ‰€æœ‰çš„å±æ€§propæ·»åŠ åˆ°è¿™ä¸ªnodeä¸Šï¼Œè¿™é‡Œæš‚æ—¶åªæœ‰titleã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
<span class="nx">node</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
</code></pre></div><p>ç„¶åæˆ‘ä»¬ä¸ºchildrenåˆ›å»ºDOMèŠ‚ç‚¹ã€‚è¿™é‡Œåªæœ‰ä¸€ä¸ªæ–‡æœ¬ä½œä¸ºchildï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸ºå®ƒåˆ›å»ºä¸€ä¸ªtext nodeã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="c1">// ç”¨textNodeè€Œä¸æ˜¯è®¾ç½®innerTextä¼šå…è®¸æˆ‘ä»¬ç¨åç”¨ç›¸åŒçš„æ–¹å¼æ¥å¤„ç†æ‰€æœ‰çš„elementsã€‚
</span><span class="c1">// åŒæ ·è¦æ³¨æ„æˆ‘ä»¬å°±åƒå¯¹h1è®¾ç½®titleå±æ€§ä¸€æ ·ï¼Œå¯¹textNodeè®¾ç½®nodeValueï¼Œå°±åƒè¿™ä¸ªå­—ç¬¦ä¸²æ‹¥æœ‰è‡ªå·±çš„props: {nodeValue: &#34;hello&#34;}ä¼¼çš„ã€‚
</span><span class="c1"></span><span class="nx">text</span><span class="p">[</span><span class="s1">&#39;nodeValue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
</code></pre></div><p>æœ€åï¼ŒæŠŠtextæ·»åŠ åˆ°h1 nodeä¸­ï¼ŒæŠŠnodeæ·»åŠ åˆ°containerä¸­ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">node</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</code></pre></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å®ç°äº†ä¹‹å‰ä¾é React JSXå’ŒReact.renderæ‰å®ç°çš„åŠŸèƒ½ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;h1&#39;</span><span class="p">,</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
        <span class="nx">children</span><span class="o">:</span> <span class="s1">&#39;Hello&#39;</span> 
    <span class="p">}</span>
<span class="p">};</span>
<span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">node</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
<span class="nx">node</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="nx">text</span><span class="p">[</span><span class="s1">&#39;nodeValue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
<span class="nx">node</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</code></pre></div><h1 id="ç¬¬1æ­¥-createelementå‡½æ•°">ç¬¬1æ­¥ createElementå‡½æ•°</h1>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨å¦ä¸€ä¸ªappé‡æ–°å¼€å§‹ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">a</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
    <span class="o">&lt;</span><span class="nx">b</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">)</span>
<span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">)</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>
</code></pre></div><p>è¿™æ¬¡æˆ‘ä»¬ä¼šç”¨æˆ‘ä»¬è‡ªå·±ç‰ˆæœ¬çš„Reactå»æ›¿æ¢åŸæ¥çš„Reactã€‚
æˆ‘ä»¬ä»å®ç°createElementå‡½æ•°å¼€å§‹ã€‚è®©æˆ‘ä»¬å°†JSXè½¬æ¢ä¸ºJSï¼Œä»è€Œçœ‹è§createElementçš„è°ƒç”¨ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span>
    <span class="s1">&#39;div&#39;</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span>
    <span class="p">[</span>
        <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span>
        <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div><p>æ­£å¦‚æˆ‘ä»¬ä¸Šä¸€æ­¥çœ‹åˆ°çš„é‚£æ ·ï¼Œä¸€ä¸ªelementæ˜¯ä¸€ä¸ªåŒ…å«typeå’Œpropsä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ã€‚æ‰€ä»¥æˆ‘ä»¬çš„å‡½æ•°åªéœ€è¦æ‰§è¡Œåˆ›å»ºå¯¹è±¡çš„å·¥ä½œã€‚
ç°åœ¨æˆ‘ä»¬æ¥å®ç°createElementå‡½æ•°ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">//æˆ‘ä»¬å¯¹propsä½¿ç”¨...æ‰©å±•ç¬¦å·ï¼Œå¯¹childrenä½¿ç”¨å‰©ä½™ç¬¦å·ï¼Œè¿™æ ·childrençš„å€¼å°†ä¸€å®šæ˜¯æ•°ç»„ã€‚
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">createElement</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="p">...</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">type</span><span class="p">,</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
            <span class="p">...</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">children</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
<span class="c1">// { type: &#39;div&#39;, props: { children: [] } }
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">a</span><span class="p">);</span>
<span class="c1">// { type: &#39;div&#39;, props: { children: [a] } }
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
<span class="c1">// { type: &#39;div&#39;, props: { children: [a, b] } }
</span></code></pre></div><p>childrenæ•°ç»„ä¹Ÿå¯ä»¥åŒ…å«åŸºæœ¬ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²æˆ–æ•°å­—ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šå°†éå¯¹è±¡çš„ç±»å‹åŒ…è£¹åœ¨ä¸€ä¸ªelementä¸­ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªç‰¹æ®Štypeï¼Œåå«TEXT_ELEMENTã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">createElement</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">props</span><span class="p">,</span> <span class="p">...</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">type</span><span class="p">,</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
            <span class="p">...</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">children</span><span class="o">:</span> <span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">typeof</span> <span class="nx">child</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="nx">child</span> <span class="o">:</span> <span class="nx">createTextElement</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">createTextElement</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;TEXT_ELEMENT&#39;</span><span class="p">,</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">nodeValue</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span>
            <span class="nx">children</span><span class="o">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>æ³¨æ„ï¼ŒReactæºç å¹¶æ²¡æœ‰åƒè¿™æ ·åŒ…è£¹åŸºæœ¬ç±»å‹å€¼æˆ–åœ¨æ²¡æœ‰childrenæ—¶åˆ›å»ºç©ºæ•°ç»„ï¼Œä½†æˆ‘ä»¬è¿™æ ·åšå¯ä»¥ç®€åŒ–ä»£ç ã€‚å¯¹äºæˆ‘ä»¬çš„åº“ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢ç®€å•çš„ä»£ç ï¼Œè€Œéé«˜æ€§èƒ½çš„ä»£ç ã€‚</p>
<p>ä¸Šæ–‡æˆ‘ä»¬è¿˜åœ¨ç”¨React.createElementã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ç”¨Didactæ¥æ›¿æ¢Reactï¼Œè¡¨æ˜ä¸ºæˆ‘ä»¬è‡ªå·±å®ç°çš„åº“ã€‚ç›®å‰ï¼Œè®©å®ƒåŒ…å«ä¸Šé¢åˆšåˆšå®ç°çš„createElementæ–¹æ³•ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">Didact</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">createElement</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">Didact</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span>
    <span class="s1">&#39;div&#39;</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span> <span class="p">},</span>
    <span class="p">[</span>
        <span class="nx">Didact</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span>
        <span class="nx">Didact</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div><p>ä¸Šé¢æ˜¯ç¼–è¯‘åçš„JSä»£ç ã€‚åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—ç”¨JSXã€‚é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆè®©babelçŸ¥é“è¦ç¼–è¯‘æˆDidact.createElementè€Œä¸æ˜¯Reactçš„createElementå‘¢ï¼Ÿ
åƒè¿™æ ·æ³¨é‡Šï¼Œå½“babelç¼–è¯‘JSXæ—¶å®ƒå°±ä¼šç”¨æˆ‘ä»¬å®šä¹‰çš„å‡½æ•°ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="cm">/** @jsx Didact.createElement */</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">a</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
    <span class="o">&lt;</span><span class="nx">b</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">)</span>
</code></pre></div><h1 id="ç¬¬2æ­¥-renderå‡½æ•°">ç¬¬2æ­¥ renderå‡½æ•°</h1>
<p>åˆ›å»ºå¥½äº†elementï¼Œç°åœ¨æˆ‘ä»¬è¦å®ç°è‡ªå·±çš„renderå‡½æ•°ï¼Œå°†ä¸€ä¸ªobjectè½¬æ¢ä¸ºDOMèŠ‚ç‚¹å¹¶æ·»åŠ åˆ°containerä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>
</code></pre></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬åªå…³æ³¨æ·»åŠ èŠ‚ç‚¹åˆ°DOMä¸­ã€‚æˆ‘ä»¬ç¨åä¼šå†å¤„ç†updateå’Œdeleteæ“ä½œã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">Didact</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">createElement</span><span class="p">,</span>
    <span class="nx">render</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO create dom nodes
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// ...jsx
</span><span class="c1">// const container = document.getElementById(&#39;root&#39;)
</span><span class="c1"></span><span class="nx">Didact</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">);</span>
</code></pre></div><p>æˆ‘ä»¬ä»æ ¹æ®typeåˆ›å»ºä¸€ä¸ªDOM nodeï¼Œç„¶åå°†è¯¥nodeæ·»åŠ åˆ°containerä¸­å¼€å§‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åœ¨è¿™é‡Œä¹Ÿè¦å¯¹textèŠ‚ç‚¹ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœtypeä¸ºä¹‹å‰è®¾å®šçš„TEXT_ELEMENTï¼Œåˆ™éœ€è¦è°ƒç”¨createTextNodeæ–¹æ³•
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">dom</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;TEXT_ELEMENT&#39;</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    
    <span class="c1">// è¿˜è®°å¾—æ¯ä¸ªelementçš„å±æ€§å—ï¼Ÿé™¤äº†childrenï¼Œå…¶ä½™çš„å±æ€§éƒ½è¦ç»‘å®šåˆ°å¯¹åº”çš„DOM nodeä¸Š
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isProperty</span> <span class="o">=</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;children&#39;</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isProperty</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">dom</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">});</span>

    <span class="c1">// ç„¶åå¯¹elementçš„æ¯ä¸ªå­èŠ‚ç‚¹åšé€’å½’æ“ä½œï¼Œç”ŸæˆDOM nodeå¹¶æ·»åŠ åˆ°è¯¥elementå¯¹åº”çš„DOM nodeä¸­ï¼Œå½¢æˆçœŸæ­£çš„DOMæ ‘
</span><span class="c1"></span>    <span class="nx">element</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">render</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">dom</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dom</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>å®Œæˆã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå¯ä»¥å°†JSXè½¬è¯‘ä¸ºDOMçš„åº“äº†ã€‚https://codesandbox.io/s/didact-2-k6rbj?file=/src/index.js</p>
<h1 id="ç¬¬3æ­¥-concurrentæ¨¡å¼">ç¬¬3æ­¥ concurrentæ¨¡å¼</h1>
<p>åœ¨æ·»åŠ æ›´å¤šä»£ç å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸ªé‡æ„ã€‚ä¸Šé¢çš„forEach renderé€’å½’è°ƒç”¨å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“elementæ ‘å¤ªå¤§æ—¶ï¼Œå®ƒå¯èƒ½ä¼šé˜»æ–­ä¸»çº¿ç¨‹å¤ªä¹…ã€‚
è€Œä¸”ï¼Œå¦‚æœæµè§ˆå™¨éœ€è¦æ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„å·¥ä½œï¼Œä¾‹å¦‚æäº¤ç”¨æˆ·è¾“å…¥ï¼Œæˆ–è€…ä¿éšœåŠ¨ç”»æµç•…æ’­æ”¾ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±è¦ç­‰åˆ°å®ƒå®Œæˆæ¸²æŸ“ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦å°†æ¸²æŸ“å·¥ä½œæ‹†åˆ†æˆå°çš„å•å…ƒï¼Œæ¯æ‰§è¡Œå®Œä¸€ä¸ªï¼Œæµè§ˆå™¨å‘ç°è¿˜æœ‰åˆ«çš„æ˜¯äº‹æƒ…è¦åšçš„è¯å°±ä¼šä¸­æ–­æ¸²æŸ“ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// æˆ‘ä»¬ç”¨requestIdleCallbackæ¥å»ºç«‹ä¸€ä¸ªå¾ªç¯ã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œsetTimeoutï¼Œä½†æ˜¯ä¸æ˜¯ç”±æˆ‘ä»¬å»å‘Šè¯‰å®ƒä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œè€Œæ˜¯ç”±æµè§ˆå™¨åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ˜¯å»æ‰§è¡Œcallbackã€‚
</span><span class="c1"></span>
<span class="c1">// Reactä¸å†ä½¿ç”¨requestIdleCallbackã€‚ç°åœ¨å®ƒä½¿ç”¨scheduler packageã€‚ä½†æ˜¯åœ¨è¿™ä¸ªç”¨ä¾‹ä¸­å®ƒä»¬çš„æ¦‚å¿µæ˜¯ç±»ä¼¼çš„ã€‚
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="c1">// å…¥å‚deadlineå¯ä»¥ç”¨æ¥æ£€æŸ¥åœ¨æµè§ˆå™¨éœ€è¦é‡æ–°take controlä¹‹å‰æˆ‘ä»¬è¿˜æœ‰å¤šå°‘æ—¶é—´å»æ‰§è¡Œæ¸²æŸ“
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">workLoop</span><span class="p">(</span><span class="nx">deadline</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">shouldYield</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="c1">// å¦‚æœè¿˜æœ‰ä»»åŠ¡ &amp;&amp; å½“å‰å¸§è¿˜æœ‰ç©ºé—²
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nx">nextUnitOfWork</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">shouldYield</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">nextUnitOfWork</span><span class="p">);</span>
        <span class="nx">shouldYield</span> <span class="o">=</span> <span class="nx">deadline</span><span class="p">.</span><span class="nx">timeRemaing</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="nx">requestIdleCallback</span><span class="p">(</span><span class="nx">workLoop</span><span class="p">)</span> <span class="c1">// ç­‰å¾…ä¸‹ä¸€å¸§
</span><span class="c1"></span><span class="p">}</span>
<span class="nx">requestIdleCallback</span><span class="p">(</span><span class="nx">workLoop</span><span class="p">)</span> <span class="c1">// å¯åŠ¨æ—¶é—´åˆ‡ç‰‡
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">nextUnitOfWork</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>As ofæˆªè‡³2019å¹´11æœˆ, Concurrent Modeè¿˜æ²¡æœ‰å‘å¸ƒç¨³å®šç‰ˆæœ¬ã€‚å¾ªç¯çš„ç¨³å®šç‰ˆæœ¬æ›´åƒæ˜¯ä¸‹é¢è¿™æ ·ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">while</span> <span class="p">(</span><span class="nx">nextUnitOfWork</span><span class="p">)</span> <span class="p">{</span>    
  <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">performUnitOfWork</span><span class="p">(</span>   
    <span class="nx">nextUnitOfWork</span>  
  <span class="p">)</span> 
<span class="p">}</span>
</code></pre></div><p>è¦å¼€å§‹ä½¿ç”¨è¿™ä¸ªå¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä»»åŠ¡çš„ç¬¬ä¸€ä¸ªå•å…ƒï¼Œç„¶åç¼–å†™performUnitOfWorkæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ä»…æ‰§è¡Œå½“å‰çš„ä»»åŠ¡ï¼Œè¿˜ä¼šè¿”å›ä¸‹ä¸€ä¸ªå•å…ƒçš„ä»»åŠ¡ã€‚</p>
<h1 id="ç¬¬4æ­¥-fiberæ ‘">ç¬¬4æ­¥ fiberæ ‘</h1>
<p>æˆ‘ä»¬éœ€è¦ä¸€ç§å½¢å¦‚çº¤ç»´æ ‘çš„æ•°æ®ç»“æ„æ¥ç»„ç»‡å•å…ƒä»»åŠ¡ã€‚æ¯ä¸ªReact elementï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„fiberï¼Œå®ƒä»¬æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š
å‡è®¾æˆ‘ä»¬è¦æ¸²æŸ“ä¸€ä¸ªåƒè¿™æ ·çš„elementæ ‘ç»“æ„åˆ°DOMä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Didact</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">p</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="nx">a</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="err">/h1&gt;</span>
    <span class="o">&lt;</span><span class="nx">h2</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;,</span>
  <span class="nx">container</span>
<span class="p">)</span>
</code></pre></div><p><figure>
		<a href="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber1.png" data-size="274x318">
			<img srcset="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber1_hu7839c0de918d55ea891144c58fa5e709_3678_480x0_resize_box_2.png 480w, /ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber1_hu7839c0de918d55ea891144c58fa5e709_3678_1024x0_resize_box_2.png 1024w"
				src="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber1.png" width="274" height="318" loading="lazy"
				alt="fiber1.png">
		</a>
		
		<figcaption>fiber1.png</figcaption>
		
	</figure>
åœ¨renderå‡½æ•°ä¸­æˆ‘ä»¬ä¼šåˆ›å»ºæ ¹fiberï¼Œç„¶åå°†å…¶è®¾ä¸ºnextUnitOfWorkã€‚å…¶ä½™çš„å·¥ä½œä¼šåœ¨performUnitOfWorkä¸­è¿›è¡Œï¼Œåœ¨è¯¥å‡½æ•°ä¸­æˆ‘ä»¬ä¼šå¯¹æ¯ä¸ªfiberåšä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li>add the element to the DOM å°†elementæ·»åŠ åˆ°DOM</li>
<li>create the fibers for the elementâ€™s children ä¸ºè¿™ä¸ªfiberçš„childrenåˆ›å»ºå®ƒä»¬è‡ªå·±çš„fiber</li>
<li>select the next unit of work é€‰æ‹©ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡</li>
</ol>
<p>è¿™æ ·ç±»ä¼¼çº¤ç»´çš„æ•°æ®ç»“æ„çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯ç”±äºæ¯ä¸ªfiberéƒ½å’Œè‡ªå·±çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€ç›¸é‚»èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹æœ‰ä¸€ä¸ªè¿æ¥ï¼Œå¯ä»¥å¾ˆå®¹æ˜“ç¡®è®¤ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡ï¼Œå³ä¸‹ä¸€ä¸ªè¦è¿›è¡Œæ¸²æŸ“çš„elementã€‚</p>
<ul>
<li>
<p>å½“æˆ‘ä»¬å®Œæˆäº†å¯¹ä¸€ä¸ªfiberçš„ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¦‚æœè¿™ä¸ªfiberæœ‰å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªå­èŠ‚ç‚¹å°±ä¼šæˆä¸ºä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡ã€‚å¯¹äºæœ¬ä¾‹ï¼Œå½“æˆ‘ä»¬å®Œæˆdivè¿™ä¸ªfiberçš„å·¥ä½œï¼Œä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡å°†ä¼šæ˜¯h1è¿™ä¸ªfiberã€‚</p>
</li>
<li>
<p>å¦‚æœå½“å‰çš„fiberæ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¼šè®©å®ƒçš„ç›¸é‚»èŠ‚ç‚¹æˆä¸ºä¸‹ä¸ªå•å…ƒä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œpè¿™ä¸ªfiberæ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šåœ¨å®Œæˆæ¸²æŸ“å®ƒä¹‹åç§»åŠ¨åˆ°aè¿™ä¸ªfiberã€‚
<figure>
		<a href="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber3.png" data-size="274x318">
			<img srcset="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber3_huc1596146e0ca06b53eeb167d1b09910d_3705_480x0_resize_box_2.png 480w, /ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber3_huc1596146e0ca06b53eeb167d1b09910d_3705_1024x0_resize_box_2.png 1024w"
				src="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber3.png" width="274" height="318" loading="lazy"
				alt="fiber3.png">
		</a>
		
		<figcaption>fiber3.png</figcaption>
		
	</figure></p>
</li>
<li>
<p>è€Œå¦‚æœè¿™ä¸ªfiberæ²¡æœ‰å­èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰ç›¸é‚»èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ä¼šå»æ‰¾å®ƒçš„â€œå”å”â€ï¼šçˆ¶èŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹ï¼Œä¾‹å¦‚æœ¬ä¾‹ä¸­çš„h2ã€‚
<figure>
		<a href="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber4.png" data-size="274x318">
			<img srcset="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber4_hu4bf1c65f00b4e8a037288ff97bc35961_3781_480x0_resize_box_2.png 480w, /ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber4_hu4bf1c65f00b4e8a037288ff97bc35961_3781_1024x0_resize_box_2.png 1024w"
				src="/ObzerverZQ.github.io/p/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0react/fiber4.png" width="274" height="318" loading="lazy"
				alt="fiber4.png">
		</a>
		
		<figcaption>fiber4.png</figcaption>
		
	</figure>
å¦å¤–ï¼Œå¦‚æœçˆ¶èŠ‚ç‚¹æ²¡æœ‰ç›¸é‚»èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸Šæ²¿ç€çˆ¶èŠ‚ç‚¹å¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°äº†æœ‰ç›¸é‚»èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œæˆ–è€…æ˜¯åˆ°è¾¾æ ¹èŠ‚ç‚¹ã€‚å¦‚æœæˆ‘ä»¬åˆ°è¾¾äº†æ ¹èŠ‚ç‚¹ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬å·²ç»å®Œæˆäº†å¯¹è¿™æ¬¡renderçš„æ‰€æœ‰ä»»åŠ¡ã€‚</p>
</li>
</ul>
<p>ç°åœ¨è®©æˆ‘ä»¬ç”¨ä»£ç è¿›è¡Œå®ç°å§ï¼</p>
<p>é¦–å…ˆå°†åŸå…ˆrenderå‡½æ•°é‡Œçš„åˆ›å»ºDOMçš„ä»£ç æŠ½ç¦»å‡ºæ¥ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åˆ›å»ºDOM
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">dom</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;TEXT_ELEMENT&#39;</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">isProperty</span> <span class="o">=</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;children&#39;</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isProperty</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">dom</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">});</span>

    <span class="c1">// å¯¹å­èŠ‚ç‚¹é€’å½’è°ƒç”¨
</span><span class="c1"></span>    <span class="nx">element</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">render</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">dom</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="c1">// æ·»åŠ åˆ°å®¹å™¨ä¸­
</span><span class="c1"></span>    <span class="nx">container</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">dom</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>å°†åˆ›å»ºDOMçš„éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥å½¢æˆä¸€ä¸ªæ–°çš„æ–¹æ³•createDOMï¼Œå…¥å‚ä¸ºfiberï¼Œå³elementã€‚ç¨åæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">createDom</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">dom</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;TEXT_ELEMENT&#39;</span> <span class="o">?</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">isProperty</span> <span class="o">=</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;children&#39;</span><span class="p">;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isProperty</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">dom</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="p">});</span>
    <span class="k">return</span> <span class="nx">dom</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>ç„¶åï¼Œåœ¨renderæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æŠŠfiberæ ‘çš„æ ¹èŠ‚ç‚¹ä½œä¸ºnextUnitOfWork:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">render</span> <span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æœ€åˆæœ€åˆçš„èŠ‚ç‚¹ä¸ºcontainerï¼Œä¸€ä¸ªå·²æœ‰çš„DOMèŠ‚ç‚¹ï¼Œæ”¾åœ¨nextUnitOfWorkï¼Œå³fiberçš„domå±æ€§ä¸­
</span><span class="c1"></span>    <span class="c1">// nextUnitOfWorkå¯¹è±¡è¿˜æœ‰typeå±æ€§ï¼Œæœ€åˆèŠ‚ç‚¹æ²¡æœ‰è‡ªèº«å±æ€§ï¼Œåªæœ‰childrenï¼ŒåŒ…å«ä¸€ä¸ªæˆ‘ä»¬åˆ›å»ºå¥½çš„element
</span><span class="c1"></span>    <span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">dom</span><span class="o">:</span> <span class="nx">container</span><span class="p">,</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="nx">element</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="kc">null</span>
</code></pre></div><p>ç„¶åï¼Œå½“æµè§ˆå™¨readyåï¼Œå®ƒä¼šè°ƒç”¨æˆ‘ä»¬ä¸Šé¢æ‰€å†™çš„workLoopæ–¹æ³•ï¼Œæˆ‘ä»¬å°±ä¼šå¼€å§‹ä»rootè¿›è¡Œæ¸²æŸ“å·¥ä½œã€‚
ç°åœ¨æˆ‘ä»¬æ¥å®ç°performUnitOfWorkæ–¹æ³•ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 1. é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„DOM nodeï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°DOMä¸­
</span><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬ç”¨fiber.domå±æ€§å»è¿½è¸ªDOMèŠ‚ç‚¹ä¿¡æ¯
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">createDom</span><span class="p">(</span><span class="nx">fiber</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 2. ç„¶åæˆ‘ä»¬ä¸ºæ¯ä¸€ä¸ªå­èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–°çš„fiber
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">prevSibling</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kr">const</span> <span class="nx">newFiber</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
            <span class="nx">props</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">dom</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">parent</span><span class="o">:</span> <span class="nx">fiber</span>
        <span class="p">}</span>
        <span class="c1">// å»ºç«‹fiberè¿æ¥ï¼Œæ ¹æ®ç´¢å¼•æ˜¯å¦ä¸º0è®¾ç½®ä¸ºå½“å‰fiberçš„childæˆ–æ˜¯ä¸Šä¸€ä¸ªå­èŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">newFiber</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">prevSibling</span><span class="p">.</span><span class="nx">sibling</span> <span class="o">=</span> <span class="nx">newFiber</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">prevSibling</span> <span class="o">=</span> <span class="nx">newFiber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 3. æœ€åæˆ‘ä»¬æœç´¢å¹¶ç¡®ç«‹ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡ã€‚æˆ‘ä»¬å…ˆè¯•è¯•å­èŠ‚ç‚¹childï¼Œæ²¡æœ‰childçš„è¯å°±ç›¸é‚»èŠ‚ç‚¹=ã€‹çˆ¶èŠ‚ç‚¹çš„ç›¸é‚»èŠ‚ç‚¹è¿™æ ·å¾ªç¯æœç´¢ã€‚
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>ä»¥ä¸Šå°±æ˜¯performUnitOfWorkæ–¹æ³•çš„å®ç°ã€‚</p>
<h1 id="ç¬¬5æ­¥renderå’Œcommité˜¶æ®µ">ç¬¬5æ­¥ï¼šRenderå’ŒCommité˜¶æ®µ</h1>
<p>ç°åœ¨æˆ‘ä»¬è¿˜é¢ä¸´ä¸€ä¸ªé—®é¢˜ã€‚æ¯æ¬¡æˆ‘ä»¬å¯¹ä¸€ä¸ªelementè¿›è¡Œæ“ä½œæ—¶ï¼Œéƒ½ä¼šå°†ä¸€ä¸ªæ–°çš„nodeèŠ‚ç‚¹é‚£æ·»åŠ åˆ°DOMä¸­ï¼Œä½†æ˜¯è®°ä½ï¼Œæµè§ˆå™¨å¯ä»¥åœ¨æˆ‘ä»¬å®Œæˆæ¸²æŸ“æ•´ä¸ªæ ‘ç»“æ„ä¹‹å‰ä¸­æ–­æ¸²æŸ“å·¥ä½œå»æ‰§è¡Œæ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œåœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä¼šçœ‹è§ä¸€ä¸ªä¸å®Œæ•´çš„UIã€‚æˆ‘ä»¬ä¸å¸Œæœ›é‚£ç§æƒ…å†µå‘ç”Ÿã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä¿®æ”¹DOMçš„ä»£ç ç‰‡æ®µæŠ½ç¦»å‡ºæ¥ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// ä¿®æ”¹DOMï¼Œéœ€è¦æå‡ºå»
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>åä¹‹ï¼Œæˆ‘ä»¬éœ€è¦æŒç»­è·Ÿè¸ªfiberæ ‘çš„æ ¹ã€‚æˆ‘ä»¬ç§°å®ƒä¸ºwork in progress rootæˆ–wipRootã€‚åœ¨renderæ–¹æ³•ä¸­é‡æ–°å‘½åï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">render</span> <span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">wipRoot</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">dom</span><span class="o">:</span> <span class="nx">container</span><span class="p">,</span>
        <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="nx">element</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">wipRoot</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</code></pre></div><p>ç„¶åï¼Œå½“æˆ‘ä»¬å®Œæˆäº†æ‰€æœ‰çš„æ¸²æŸ“å·¥ä½œï¼ˆä¸å­˜åœ¨ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡æ—¶ï¼‰æˆ‘ä»¬å°†æ•´ä¸ªfiberæ ‘æäº¤åˆ°DOMä¸­ï¼ˆæ¯ä¸ªfiberéƒ½å·²ç»å¸¦æœ‰äº†å®ƒå¯¹åº”è¦æ¸²æŸ“åˆ°documentä¸Šçš„é™„å¸¦å±æ€§çš„DOMèŠ‚ç‚¹ï¼‰ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">commitRoot</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// TODO add nodes to dom
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">wipRoot</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">dom</span><span class="o">:</span> <span class="nx">container</span><span class="p">,</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="nx">element</span><span class="p">],</span>
    <span class="p">},</span>
  <span class="p">}</span>
  <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">wipRoot</span>
<span class="p">}</span>
<span class="err">â€‹</span>
<span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="kc">null</span>
<span class="kd">let</span> <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span>
<span class="err">â€‹</span>
<span class="kd">function</span> <span class="nx">workLoop</span><span class="p">(</span><span class="nx">deadline</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">shouldYield</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">nextUnitOfWork</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">shouldYield</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">performUnitOfWork</span><span class="p">(</span>
      <span class="nx">nextUnitOfWork</span>
    <span class="p">)</span>
    <span class="nx">shouldYield</span> <span class="o">=</span> <span class="nx">deadline</span><span class="p">.</span><span class="nx">timeRemaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="err">â€‹</span>  <span class="c1">// æ²¡æœ‰ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡ï¼Œè¯´æ˜fiberæ ‘æ„å»ºå®Œæˆï¼Œæ•´ä½“æäº¤åˆ°DOMä¸­
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nextUnitOfWork</span> <span class="o">&amp;&amp;</span> <span class="nx">wipRoot</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">commitRoot</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">requestIdleCallback</span><span class="p">(</span><span class="nx">workLoop</span><span class="p">)</span>
<span class="p">}</span>
<span class="err">â€‹</span>
<span class="nx">requestIdleCallback</span><span class="p">(</span><span class="nx">workLoop</span><span class="p">)</span>
</code></pre></div><p>æˆ‘ä»¬åœ¨commitRootæ–¹æ³•ä¸­å®ç°æäº¤åŠŸèƒ½ã€‚åœ¨commitWorké‡Œé€’å½’æ·»åŠ æ‰€æœ‰nodeåˆ°DOMæ ‘ä¸­ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">commitRoot</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// è¿™é‡Œchildå°±æ˜¯å®é™…è¦æ·»åŠ åˆ°å·²æœ‰DOMå®¹å™¨èŠ‚ç‚¹çš„æ ¹element
</span><span class="c1"></span>    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">wipRoot</span><span class="p">.</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">fiberParentDom</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">dom</span><span class="p">;</span>
    <span class="nx">fiberParentDom</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">);</span>
    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><h1 id="ç¬¬6æ­¥reconciliation-è°ƒå’Œ-diffç®—æ³•">ç¬¬6æ­¥ï¼šReconciliation è°ƒå’Œ ï¼ˆDIFFç®—æ³•ï¼‰</h1>
<p>ç›®å‰ä¸ºæ­¢æˆ‘ä»¬åªæ˜¯å®Œæˆäº†æ·»åŠ èŠ‚ç‚¹åˆ°DOMçš„å®ç°ï¼Œé‚£ä¹ˆæ›´æ–°å’Œåˆ é™¤èŠ‚ç‚¹å‘¢ï¼Ÿ
è¿™å°±æ˜¯æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œå°†æˆ‘ä»¬åœ¨renderæ–¹æ³•ä¸­æ¥æ”¶åˆ°çš„elementså’Œä¸Šä¸€ä¸ªæˆ‘ä»¬æäº¤åˆ°DOMçš„fiberæ ‘è¿›è¡Œå¯¹æ¯”ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä¸Šä¸€ä¸ªå®Œæˆæ¸²æŸ“çš„fiberæ ‘ä¿å­˜åˆ°ä¸€ä¸ªå¼•ç”¨å½“ä¸­ï¼Œæˆ‘ä»¬å«å®ƒcurrentRootã€‚
åŒæ—¶ï¼Œå¯¹æ¯ä¸€ä¸ªfiberæ·»åŠ ä¸€ä¸ªalternateå±æ€§ã€‚è¿™ä¸ªå±æ€§æ˜¯å¯¹æ—§fiberçš„é“¾æ¥ï¼Œå³æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªä»commité˜¶æ®µæäº¤åˆ°DOMçš„fiberã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">currentRoot</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">wipRoot</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">dom</span><span class="o">:</span> <span class="nx">container</span><span class="p">,</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="nx">element</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="c1">// æ·»åŠ alternateå±æ€§å­˜å‚¨ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å¯¹åº”çš„fiber
</span><span class="c1"></span>    <span class="nx">alternate</span><span class="o">:</span> <span class="nx">currentRoot</span>
  <span class="p">}</span>
  <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">wipRoot</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">commitRoot</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// è¿™é‡Œchildå°±æ˜¯å®é™…è¦æ·»åŠ åˆ°å·²æœ‰DOMå®¹å™¨èŠ‚ç‚¹çš„æ ¹element
</span><span class="c1"></span>    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">wipRoot</span><span class="p">.</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">currentRoot</span> <span class="o">=</span> <span class="nx">wipRoot</span><span class="p">;</span>
    <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">fiberParentDom</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">dom</span><span class="p">;</span>
    <span class="nx">fiberParentDom</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">);</span>
    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>ç°åœ¨è®©æˆ‘ä»¬æŠŠperformUnitOfWorkä¸­åˆ›å»ºæ–°fiberçš„ä»£ç æŠ½ç¦»å‡ºæ¥ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">createDom</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span>
  <span class="p">}</span>
<span class="err">â€‹</span>
  <span class="kr">const</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span>
  <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">let</span> <span class="nx">prevSibling</span> <span class="o">=</span> <span class="kc">null</span>
<span class="err">â€‹</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
<span class="err">â€‹</span>
    <span class="kr">const</span> <span class="nx">newFiber</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
      <span class="nx">parent</span><span class="o">:</span> <span class="nx">fiber</span><span class="p">,</span>
      <span class="nx">dom</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">}</span>
<span class="err">â€‹</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">prevSibling</span><span class="p">.</span><span class="nx">sibling</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="p">}</span>
    <span class="nx">prevSibling</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="nx">index</span><span class="o">++</span>
  <span class="p">}</span>
<span class="err">â€‹</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">fiber</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span>
    <span class="p">}</span>
    <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">parent</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">createDom</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span>
  <span class="c1">// å½“å‰çš„fiberå’Œå®ƒçš„å­èŠ‚ç‚¹ä»¬ï¼Œè°ƒç”¨æ„å»ºfiberæ ‘ç»“æ„å‡½æ•°reconcileChildren
</span><span class="c1"></span>  <span class="nx">reconcileChildren</span><span class="p">(</span><span class="nx">fiber</span><span class="p">,</span> <span class="nx">elements</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">fiber</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span>
    <span class="p">}</span>
    <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">parent</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">reconcileChildren</span><span class="p">(</span><span class="nx">wipFiber</span><span class="p">,</span> <span class="nx">elements</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">let</span> <span class="nx">prevSibling</span> <span class="o">=</span> <span class="kc">null</span>
<span class="err">â€‹</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
<span class="err">â€‹</span>
    <span class="kr">const</span> <span class="nx">newFiber</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
      <span class="nx">props</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
      <span class="nx">parent</span><span class="o">:</span> <span class="nx">wipFiber</span><span class="p">,</span>
      <span class="nx">dom</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">prevSibling</span><span class="p">.</span><span class="nx">sibling</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="p">}</span>
    <span class="nx">prevSibling</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="nx">index</span><span class="o">++</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>ç»§ç»­ä¿®æ”¹reconcileChildrenï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šå°†æ—§çš„fiberså’Œæ–°çš„elementsè¿›è¡Œè°ƒå’Œã€‚
We iterate at the same time over the children of the old fiber (wipFiber.alternate) and the array of elements we want to reconcile.</p>
<p>å¦‚æœæˆ‘ä»¬å¿½ç•¥æ‰€æœ‰åœ¨ä¸€ä¸ªæ•°ç»„å’Œä¸€ä¸ªé“¾è¡¨ä¸ŠåŒæ—¶éå†çš„æ ·æ¿ä»£ç ï¼ˆboilerplateï¼‰ã€‚æˆ‘ä»¬ä¼šå¾—åˆ°è¿™é‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªå˜é‡ï¼šoldFiberå’Œelementã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å¯¹æ¯”è¿™ä¸¤ä¸ªå˜é‡ï¼Œå³è¿™æ¬¡è¦æ¸²æŸ“çš„fiberçš„å­fiberå’Œä¸Šæ¬¡çš„å­fiberï¼Œæ¥ç¡®è®¤æˆ‘ä»¬æ—¶å€™è¦å°†ä»€ä¹ˆå˜åŒ–åº”ç”¨åˆ°DOMä¸Šã€‚</p>
<p>æˆ‘ä»¬ç”¨typeæ¥æ¯”è¾ƒå®ƒä»¬:</p>
<ul>
<li>å¦‚æœæ—§fiberå’Œæ–°elementçš„typeç›¸åŒï¼Œæˆ‘ä»¬å¯ä»¥è®©DOM nodeç•™åœ¨é‚£é‡Œï¼Œåªæ›´æ–°ä¸€äº›æ–°çš„å±æ€§ã€‚</li>
<li>å¦‚æœtypeä¸åŒï¼Œæœ‰ä¸€ä¸ªæ–°çš„elementï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„node</li>
<li>å¦‚æœtypeä¸åŒï¼Œæœ‰ä¸€ä¸ªæ—§çš„fiberï¼Œæˆ‘ä»¬éœ€è¦ç§»é™¤æ‰æ—§çš„DOM node</li>
</ul>
<p>è¿™é‡ŒReactä¹Ÿä½¿ç”¨keysè¿™ä¸ªå±æ€§ï¼Œè¿™è®©è°ƒå’Œæ•ˆæœæ›´å¥½ã€‚ä¾‹å¦‚ï¼Œå®ƒä¼šå‘ç°å­èŠ‚ç‚¹ä»¬åœ¨elementæ•°ç»„ä¸­çš„æ’åˆ—é¡ºåºçš„æ”¹å˜ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">reconcileChildren</span><span class="p">(</span><span class="nx">wipFiber</span><span class="p">,</span> <span class="nx">elements</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="c1">// ä¸Šæ¬¡æ¸²æŸ“åˆ°DOMçš„å¯¹åº”èŠ‚ç‚¹çš„å­fiber
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">oldFiber</span> <span class="o">=</span> <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">alternate</span> <span class="o">&amp;&amp;</span> <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="nx">child</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">prevSibling</span> <span class="o">=</span> <span class="kc">null</span>
<span class="err">â€‹</span>
  <span class="c1">// å¾ªç¯æ¡ä»¶å¢åŠ oldFiberä¸ä¸ºç©º
</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">oldFiber</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// elementæ˜¯ç°åœ¨è¦æ¸²æŸ“åˆ°DOMä¸Šçš„èŠ‚ç‚¹çš„å­fiber
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
<span class="err">â€‹</span>    <span class="kd">let</span> <span class="nx">newFiber</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">// å°†æ—§fiberå’Œç°elementè¿›è¡Œæ¯”è¾ƒ
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">sameType</span> <span class="o">=</span> <span class="nx">element</span> <span class="o">&amp;&amp;</span> <span class="nx">oldFiber</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">oldFiber</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="c1">// æ›´æ–°èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">sameType</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„fiberï¼Œç»´æŒæ—§fiberçš„domï¼Œè®¾ç½®æ–°elementçš„props
</span><span class="c1"></span>        <span class="c1">// åŒæ—¶æ·»åŠ ä¸€ä¸ªæ–°å±æ€§effectTagï¼Œè¿™ä¸ªå±æ€§ä¼šåœ¨ç¨åçš„commité˜¶æ®µç”¨åˆ°
</span><span class="c1"></span>        <span class="nx">newFiber</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">oldFiber</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
            <span class="nx">props</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">dom</span><span class="o">:</span> <span class="nx">oldFiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">,</span>
            <span class="nx">parent</span><span class="o">:</span> <span class="nx">wipFiber</span><span class="p">,</span>
            <span class="nx">effectTag</span><span class="o">:</span> <span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
            <span class="nx">alternate</span><span class="o">:</span> <span class="nx">oldFiber</span>
        <span class="p">}</span>
    <span class="c1">// æ·»åŠ æ–°èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sameType</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¯¹äºelementéœ€è¦ä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹çš„caseï¼Œæˆ‘ä»¬å¯¹æ–°fiberæ·»åŠ ä¸€ä¸ªå€¼ä¸ºPLACEMENTçš„tag
</span><span class="c1"></span>        <span class="nx">newFiber</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
            <span class="nx">props</span><span class="o">:</span> <span class="nx">element</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">dom</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>  <span class="c1">// åé¢ä¼šç”¨fiberæ¥è°ƒç”¨createDomï¼Œè¿™é‡Œåªæ˜¯å°†elementè½¬ä¸ºfiber
</span><span class="c1"></span>            <span class="nx">parent</span><span class="o">:</span> <span class="nx">wipFiber</span><span class="p">,</span>
            <span class="nx">effectTag</span><span class="o">:</span> <span class="s1">&#39;PLACEMENT&#39;</span><span class="p">,</span>
            <span class="nx">alternate</span><span class="o">:</span> <span class="kc">null</span>
        <span class="p">}</span>
    <span class="c1">// åˆ é™¤æ—§èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sameType</span> <span class="o">&amp;&amp;</span> <span class="nx">oldFiber</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¯¹äºè¦åˆ é™¤nodeçš„caseï¼Œæˆ‘ä»¬æ²¡æœ‰æ–°çš„fiberï¼Œæ‰€ä»¥å¯¹æ—§fiberæ·»åŠ ä¸€ä¸ªDELETIONçš„tagã€‚
</span><span class="c1"></span>        <span class="nx">oldFiber</span><span class="p">.</span><span class="nx">effectTag</span> <span class="o">=</span> <span class="s1">&#39;DELETION&#39;</span><span class="p">;</span>
        <span class="c1">// ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ˜¯ä»wipRootæäº¤fiberæ ‘åˆ°DOMä¸­çš„ï¼Œè¿™ä¸ªfiberæ ‘ç»“æ„å·²ç»ä¸å†åŒ…å«æ—§çš„fiberäº†
</span><span class="c1"></span>        <span class="c1">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°ç»„deletionsæ¥è®°å½•æˆ‘ä»¬è¦ç§»é™¤çš„nodeèŠ‚ç‚¹
</span><span class="c1"></span>        <span class="nx">deletions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">oldFiber</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">prevSibling</span><span class="p">.</span><span class="nx">sibling</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="p">}</span>
    <span class="nx">prevSibling</span> <span class="o">=</span> <span class="nx">newFiber</span>
    <span class="nx">index</span><span class="o">++</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">wipRoot</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">dom</span><span class="o">:</span> <span class="nx">container</span><span class="p">,</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">children</span><span class="o">:</span> <span class="p">[</span><span class="nx">element</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="nx">alternate</span><span class="o">:</span> <span class="nx">currentRoot</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="c1">// æ¯æ¬¡å¼€å§‹æ¸²æŸ“æ—¶ï¼Œåˆå§‹åŒ–è¦ç§»é™¤çš„nodeèŠ‚ç‚¹ä¸ºç©ºæ•°ç»„
</span><span class="c1"></span>  <span class="nx">deletions</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">wipRoot</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="kc">null</span>
<span class="kd">let</span> <span class="nx">currentRoot</span> <span class="o">=</span> <span class="kc">null</span>
<span class="kd">let</span> <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span>
<span class="kd">let</span> <span class="nx">deletions</span> <span class="o">=</span> <span class="kc">null</span>

<span class="c1">// ç„¶åï¼Œå½“æˆ‘ä»¬å°†å˜æ›´æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯¹é‚£ä¸ªæ•°ç»„ä¸­çš„fiberè°ƒç”¨commitWorkã€‚
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">commitRoot</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">deletions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">commitWork</span><span class="p">)</span>
  <span class="nx">commitWork</span><span class="p">(</span><span class="nx">wipRoot</span><span class="p">.</span><span class="nx">child</span><span class="p">)</span>
  <span class="nx">currentRoot</span> <span class="o">=</span> <span class="nx">wipRoot</span>
  <span class="nx">wipRoot</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">}</span>
<span class="err">â€‹</span>
</code></pre></div><p>æ¥ä¸‹æ¥è¦ä¿®æ”¹commitWorkæ–¹æ³•æ¥å¤„ç†ä¸Šé¢å¢åŠ çš„effectTagï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">domParent</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">dom</span><span class="p">;</span>
    <span class="c1">// å¦‚æœfiberæœ‰PLACEMENTè¿™ä¸ªeffect tagæˆ‘ä»¬å°±å’Œä¹‹å‰ä¸€æ ·ï¼Œæ·»åŠ fiberçš„domèŠ‚ç‚¹åˆ°å®ƒçš„parentçš„domèŠ‚ç‚¹ä¸­å»ã€‚
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">effectTag</span> <span class="o">===</span> <span class="s1">&#39;PLACEMENT&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">domParent</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span>
        <span class="c1">// å¦‚æœæ˜¯UPDATEï¼Œé‚£ä¹ˆå°±å°†æ–°fiberçš„propsæ›´æ–°åˆ°å·²æœ‰çš„domèŠ‚ç‚¹ä¸­
</span><span class="c1"></span>        <span class="c1">// å¹¶ä¸”æ›¿æ¢æ‰ä¹‹å‰å·²æœ‰çš„propsçš„å€¼
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">effectTag</span> <span class="o">===</span> <span class="s1">&#39;UPDATE&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">updateDom</span><span class="p">(</span>
            <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">,</span>
            <span class="nx">fiber</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span>
        <span class="p">)</span>
      <span class="c1">// å¦‚æœæ˜¯DELETIONï¼Œæˆ‘ä»¬å°±åšç›¸åæ“ä½œï¼Œç§»é™¤å­èŠ‚ç‚¹
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">effectTag</span> <span class="o">===</span> <span class="s1">&#39;DELETION&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">domParent</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">);</span>
    <span class="nx">commitWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>æ¥ä¸‹æ¥è¦å®ç°updateDomæ–¹æ³•ã€‚æˆ‘ä»¬å°†æ—§fiberå’Œæ–°fiberçš„propsè¿›è¡Œæ¯”è¾ƒï¼Œç§»é™¤é‚£äº›ä¸å†æœ‰çš„propsï¼Œå¹¶ä¸”è®¾ç½®é‚£äº›æ–°çš„propsæˆ–è€…æ˜¯å˜åŒ–äº†çš„å€¼çš„propsã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// æ˜¯æ–°å€¼æˆ–è€…æ˜¯å…¨æ–°çš„prop
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">isNew</span> <span class="o">=</span> <span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">prev</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">next</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
<span class="kr">const</span> <span class="nx">isGone</span> <span class="o">=</span> <span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">next</span><span class="p">);</span>
<span class="c1">// æ³¨æ„ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Špropæˆ‘ä»¬å¯èƒ½éœ€è¦æ›´æ–°çš„æ˜¯event listenerã€‚æ‰€ä»¥å¦‚æœä»¥onä¸ºå¼€å¤´çš„propæˆ‘ä»¬éœ€è¦å¯¹å®ƒä»¬è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">isEvent</span> <span class="o">=</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">key</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">isProperty</span> <span class="o">=</span> <span class="nx">key</span> <span class="p">=&gt;</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;children&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isEvent</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">updateDom</span><span class="p">(</span><span class="nx">dom</span><span class="p">,</span> <span class="nx">prevProps</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å¦‚æœäº‹ä»¶ç›‘å¬å™¨å˜äº†ï¼Œæˆ–è€…ä¸å†æœ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å…ˆç§»é™¤æ‰æ—§çš„ã€‚
</span><span class="c1"></span>    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isEvent</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
            <span class="nx">key</span> <span class="p">=&gt;</span>
                <span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">nextProps</span><span class="p">)</span> <span class="o">||</span>
                <span class="nx">isNew</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">)(</span><span class="nx">key</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">eventType</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
            <span class="nx">dom</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">prevProps</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
        <span class="p">})</span>
    <span class="c1">// ç§»é™¤æ—§çš„property
</span><span class="c1"></span>    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isProperty</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isGone</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">dom</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">})</span>
    <span class="c1">// è®¾ç½®æ–°çš„æˆ–å€¼å˜äº†çš„property
</span><span class="c1"></span>    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">nextProps</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isProperty</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isNew</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">dom</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nextProps</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="p">})</span>
    <span class="c1">// ç„¶åæ·»åŠ æ–°fiberçš„äº‹ä»¶ç›‘å¬å™¨
</span><span class="c1"></span>    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">nextProps</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isEvent</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isNew</span><span class="p">(</span><span class="nx">prevProps</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">eventType</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
            <span class="nx">dom</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">nextProps</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
        <span class="p">})</span>
<span class="p">}</span>
</code></pre></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†è°ƒå’Œå·¥ä½œå•¦ï¼
å°è¯•åœ°å€ï¼šhttps://codesandbox.io/s/didact-6-96533</p>
<h1 id="ç¬¬7æ­¥å‡½æ•°ç»„ä»¶">ç¬¬7æ­¥ï¼šå‡½æ•°ç»„ä»¶</h1>
<p>æˆ‘ä»¬ä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯æ·»åŠ å¯¹å‡½æ•°å¼ç»„ä»¶çš„æ”¯æŒã€‚
é¦–å…ˆè®©æˆ‘ä»¬æ¥ä¿®æ”¹ä¸€ä¸‹ä¾‹å­ã€‚æˆ‘ä»¬ä¼šç”¨è¿™ä¸ªç®€å•çš„è¿”å›ä¸€ä¸ªh1å…ƒç´ çš„å‡½æ•°ç»„ä»¶ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// æ™®é€šå†™æ³•ï¼Œæ²¡æœ‰å¸¦è‡ªå®šä¹‰ç»„ä»¶
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">a</span><span class="o">&gt;</span><span class="nx">bar</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
    <span class="o">&lt;</span><span class="nx">b</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="p">)</span>
<span class="c1">// å‡½æ•°å¼ç»„ä»¶å†™æ³•
</span><span class="c1"></span><span class="cm">/** @jsx Didact.createElement */</span>
<span class="kd">function</span> <span class="nx">App</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hi</span> <span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">App</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span> <span class="o">/&gt;</span>
<span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">)</span>
<span class="nx">Didact</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>
</code></pre></div><p>æˆ‘ä»¬å°†è¿™æ®µjsxä»£ç è½¬è¯‘æˆjsï¼Œå°±ä¼šå˜æˆï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">App</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Didact</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span>
    <span class="s2">&#34;h1&#34;</span><span class="p">,</span>
    <span class="kc">null</span><span class="p">,</span>
    <span class="s2">&#34;Hi &#34;</span><span class="p">,</span>
    <span class="nx">props</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">)</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">Didact</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">App</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div><p>å‡½æ•°å¼ç»„ä»¶åœ¨ä¸¤ä¸ªæ–¹é¢æœ‰æ‰€åŒºåˆ«ï¼š</p>
<ul>
<li>æºè‡ªå‡½æ•°ç»„ä»¶çš„fiberæ²¡æœ‰DOMèŠ‚ç‚¹</li>
<li>å­èŠ‚ç‚¹ä»¬æ˜¯åœ¨è¿è¡Œå‡½æ•°æ—¶å¾—æ¥çš„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»propsä¸­å¾—æ¥</li>
</ul>
<p>å› æ­¤åœ¨performUnitOfWorkæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é‡æ„åˆ›å»ºdomå’Œè·å–å­èŠ‚ç‚¹çš„ä»£ç æ®µï¼Œæ”¹ä¸ºæ£€æŸ¥fiberçš„typeæ˜¯å¦æ˜¯functionï¼Œå¹¶æ ¹æ®åˆ¤æ–­ç»“æœå»æ‰§è¡Œä¸åŒçš„updateæ–¹æ³•ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">performUnitOfWork</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if (!fiber.dom) {
</span><span class="c1"></span>    <span class="c1">//     fiber.dom = createDom(fiber)
</span><span class="c1"></span>    <span class="c1">// }
</span><span class="c1"></span>    <span class="c1">// const elements = fiber.props.children
</span><span class="c1"></span>    <span class="c1">// // å½“å‰çš„fiberå’Œå®ƒçš„å­èŠ‚ç‚¹ä»¬ï¼Œè°ƒç”¨æ„å»ºfiberæ ‘ç»“æ„å‡½æ•°reconcileChildren
</span><span class="c1"></span>    <span class="c1">// reconcileChildren(fiber, elements)
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isFunctionComponent</span> <span class="o">=</span>
        <span class="nx">fiber</span><span class="p">.</span><span class="nx">type</span> <span class="k">instanceof</span> <span class="nb">Function</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isFunctionComponent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">updateFunctionComponent</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">updateHostComponent</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// éå†fiberé“¾è¡¨
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">fiber</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">sibling</span>
        <span class="p">}</span>
        <span class="nx">nextFiber</span> <span class="o">=</span> <span class="nx">nextFiber</span><span class="p">.</span><span class="nx">parent</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">â€‹</span>
<span class="c1">// åœ¨updateHostComponentä¸­æˆ‘ä»¬ä¼šå’Œä¹‹å‰åšä¸€æ ·çš„äº‹æƒ…
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">updateHostComponent</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">createDom</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span>
    <span class="c1">// å½“å‰çš„fiberå’Œå®ƒçš„å­èŠ‚ç‚¹ä»¬ï¼Œè°ƒç”¨æ„å»ºfiberæ ‘ç»“æ„å‡½æ•°reconcileChildren
</span><span class="c1"></span>    <span class="nx">reconcileChildren</span><span class="p">(</span><span class="nx">fiber</span><span class="p">,</span> <span class="nx">elements</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>åœ¨updateFunctionComponentå‡½æ•°ä¸­æˆ‘ä»¬æ‰§è¡Œè·å–ç»„ä»¶æœ¬èº«ï¼ˆå‡½æ•°ï¼‰æ¥è·å–å…¶å­èŠ‚ç‚¹ã€‚
å¯¹äºæˆ‘ä»¬çš„ä¾‹å­ï¼Œåœ¨è¿™é‡Œfiber.typeæ˜¯Appè¿™ä¸ªæ–¹æ³•ï¼Œè€Œå½“æˆ‘ä»¬å»æ‰§è¡Œå®ƒï¼Œå®ƒä¼šè¿”å›h1 è¿™ä¸ªelementã€‚
ç„¶åï¼Œä¸€æ—¦æˆ‘ä»¬è·å–åˆ°äº†å­èŠ‚ç‚¹ï¼Œreconciliationä»¥ä¸€æ ·çš„æ–¹å¼å·¥ä½œï¼Œæˆ‘ä»¬ä¸éœ€è¦åœ¨é‚£é‡Œä¿®æ”¹ä»»ä½•ä¸œè¥¿ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">updateFunctionComponent</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">)]</span>
  <span class="nx">reconcileChildren</span><span class="p">(</span><span class="nx">fiber</span><span class="p">,</span> <span class="nx">children</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹commitWorkè¿™ä¸ªæ–¹æ³•ã€‚æœ‰äº†ä¸å¸¦DOMèŠ‚ç‚¹çš„fiberï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹ã€‚
é¦–å…ˆï¼Œè¦æ‰¾åˆ°çˆ¶fiberçš„DOMèŠ‚ç‚¹æˆ‘ä»¬éœ€è¦æ²¿ç€fiberæ ‘å‘ä¸Šèµ°ï¼ŒçŸ¥é“æ‰¾åˆ°ä¸€ä¸ªæ‹¥æœ‰DOM nodeçš„fiberã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="c1">// const domParent = fiber.parent.dom;
</span><span class="c1"></span> <span class="kd">let</span> <span class="nx">domParentFiber</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nx">parent</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">domParentFiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">domParentFiber</span> <span class="o">=</span> <span class="nx">domParentFiber</span><span class="p">.</span><span class="nx">parent</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">domParent</span> <span class="o">=</span> <span class="nx">domParentFiber</span><span class="p">.</span><span class="nx">dom</span>
</code></pre></div><p>å¦å¤–ï¼Œåˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¹Ÿæ˜¯è¦æ²¿ç€fiberæ ‘å‘ä¸‹å¯»æ‰¾childï¼Œåˆ°æ‰¾åˆ°äº†æœ‰DOM nodeçš„fiberã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">effectTag</span> <span class="o">===</span> <span class="s1">&#39;DELETION&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">commitDeletion</span><span class="p">(</span><span class="nx">fiber</span><span class="p">,</span> <span class="nx">domParent</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">commitDeletion</span><span class="p">(</span><span class="nx">fiber</span><span class="p">,</span> <span class="nx">domParent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">domParent</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">fiber</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">commitDeletion</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">child</span><span class="p">,</span> <span class="nx">domParent</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/** @jsx Didact.createElement */</span>
<span class="kd">function</span> <span class="nx">App</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Hi</span> <span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">App</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span> <span class="o">/&gt;</span>
<span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">)</span>
<span class="nx">Didact</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>
</code></pre></div><h1 id="ç¬¬8æ­¥-hooks">ç¬¬8æ­¥ Hooks</h1>
<p>æœ€åä¸€æ­¥ã€‚æ—¢ç„¶æˆ‘ä»¬æœ‰äº†å‡½æ•°ç»„ä»¶ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬ä¹ŸåŠ ä¸‹stateã€‚
è®©æˆ‘ä»¬å°†ä¾‹å­æ›´æ”¹ä¸ºç»å…¸çš„counterç»„ä»¶ã€‚æ¯æ¬¡æˆ‘ä»¬ç‚¹å‡»å®ƒï¼Œå®ƒéƒ½ä¼šå°†stateåŠ 1ã€‚è¯·æ³¨æ„æˆ‘ä»¬åœ¨ä½¿ç”¨Didact.useStateæ¥è·å–å’Œæ›´æ–°counterçš„å€¼ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">Didact</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">createElement</span><span class="p">,</span>
  <span class="nx">render</span><span class="p">,</span>
  <span class="nx">useState</span><span class="p">,</span>
<span class="p">}</span>

<span class="cm">/** @jsx Didact.createElement */</span>
<span class="kd">function</span> <span class="nx">Counter</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Here is where we call the Counter function from the example. And inside that function we call useState.
</span><span class="c1"></span>  <span class="kr">const</span> <span class="p">[</span><span class="nx">state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Didact</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">h1</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setState</span><span class="p">(</span><span class="nx">c</span> <span class="p">=&gt;</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span><span class="o">&gt;</span>
      <span class="nx">Count</span><span class="o">:</span> <span class="p">{</span><span class="nx">state</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="err">/h1&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">Counter</span> <span class="o">/&gt;</span>
<span class="kr">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">)</span>
<span class="nx">Didact</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>åœ¨è°ƒç”¨å‡½æ•°ç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–ä¸€äº›å…¨å±€å˜é‡ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨useStateæ–¹æ³•ä¸­ä½¿ç”¨å®ƒä»¬ã€‚
é¦–å…ˆæˆ‘ä»¬è®¾ç½®å·¥ä½œä¸­çš„fiberã€‚
æˆ‘ä»¬åŒæ ·æ·»åŠ ä¸€ä¸ªhooksæ•°ç»„åˆ°fiberä¸­ï¼Œæ¥æ”¯æŒåœ¨åŒä¸€ä¸ªç»„ä»¶ä¸­å¤šæ¬¡è°ƒç”¨useStateã€‚å¹¶ä¸”æˆ‘ä»¬ä¿æŒè·Ÿè¸ªç°åœ¨çš„hookç´¢å¼•ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">wipFiber</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">hookIndex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">updateFunctionComponent</span><span class="p">(</span><span class="nx">fiber</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åœ¨æ›´æ–°å‡½æ•°ç»„ä»¶çš„æ–¹æ³•ä¸­åˆå§‹åŒ–hooks
</span><span class="c1"></span>    <span class="nx">wipFiber</span> <span class="o">=</span> <span class="nx">fiber</span><span class="p">;</span>
    <span class="nx">hookIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">hooks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kr">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">props</span><span class="p">)];</span>
    <span class="nx">reconcileChildren</span><span class="p">(</span><span class="nx">fiber</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>å½“å‡½æ•°ç»„ä»¶è°ƒç”¨useStateæ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å»æ£€æŸ¥æ˜¯å¦æœ‰ä¸€ä¸ªæ—§çš„hookã€‚æˆ‘ä»¬ç”¨hookç´¢å¼•å»åˆ°è¿™ä¸ªfiberçš„alternateä¸­æ£€æŸ¥ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæ—§çš„hookï¼Œæˆ‘ä»¬å°†æ—§hookä¸­çš„stateå¤åˆ¶åˆ°æ–°çš„hookä¸­ï¼›å¦‚æœæˆ‘ä»¬æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±åˆå§‹åŒ–è¿™ä¸ªstateã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ·»åŠ è¿™ä¸ªæ–°çš„hookåˆ°fiberä¸­ï¼Œç»™hookç´¢å¼•åŠ 1ï¼Œç„¶åè¿”å›è¿™ä¸ªstateã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldHook</span> <span class="o">=</span> <span class="nx">wipFiber</span> <span class="o">&amp;&amp;</span> <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="nx">hooks</span> <span class="o">&amp;&amp;</span> <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="nx">hooks</span><span class="p">[</span><span class="nx">hookIndex</span><span class="p">];</span>
    <span class="kr">const</span> <span class="nx">hook</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">state</span><span class="o">:</span> <span class="nx">oldHook</span> <span class="o">?</span> <span class="nx">oldHook</span><span class="p">.</span><span class="nx">state</span> <span class="o">:</span> <span class="nx">initial</span>
    <span class="p">}</span>
    <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">hook</span><span class="p">);</span>
    <span class="nx">hookIndex</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">hook</span><span class="p">.</span><span class="nx">state</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div><p>useStateè¿˜åº”è¯¥è¿”å›ä¸€ä¸ªæ›´æ–°stateçš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªsetStateæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªactionï¼ˆå¯¹äºCounterä¾‹å­è€Œè¨€ï¼Œè¿™ä¸ªactionå°±æ˜¯ä¸€ä¸ªè®©stateåŠ 1çš„å‡½æ•°ï¼‰ã€‚
æˆ‘ä»¬å°†é‚£ä¸ªactionæ·»åŠ åˆ°hookçš„queueé˜Ÿåˆ—ä¸­ã€‚
ç„¶åæˆ‘ä»¬åšä¸€äº›å’Œåœ¨renderå‡½æ•°ä¸­æ‰€åšçš„ç±»ä¼¼çš„äº‹æƒ…ï¼šè®¾ç½®ä¸€ä¸ªæ–°çš„å·¥ä½œä¸­rootï¼Œä½œä¸ºä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡ï¼Œè¿™æ ·work loopå°±èƒ½å¼€å§‹ä¸€ä¸ªæ–°çš„renderé˜¶æ®µã€‚</p>
<p>æ³¨æ„æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰§è¡Œactionã€‚</p>
<p>æˆ‘ä»¬åœ¨ä¸‹ä¸€æ¬¡renderç»„ä»¶æ—¶æ‰§è¡Œã€‚ä»æ—§çš„hookçš„queueä¸­è·å–æ‰€æœ‰actionsï¼Œç„¶åå°†å®ƒä»¬é€ä¸€è¿ç”¨åˆ°æ–°çš„hook stateä¸­ï¼Œå› æ­¤å½“æˆ‘ä»¬æœ€ç»ˆè¿”å›stateæ—¶å®ƒæ˜¯æ›´æ–°è¿‡çš„ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">useState</span><span class="p">(</span><span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">oldHook</span> <span class="o">=</span> <span class="nx">wipFiber</span> <span class="o">&amp;&amp;</span> <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="nx">hooks</span> <span class="o">&amp;&amp;</span> <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">alternate</span><span class="p">.</span><span class="nx">hooks</span><span class="p">[</span><span class="nx">hookIndex</span><span class="p">];</span>
    <span class="kr">const</span> <span class="nx">hook</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">state</span><span class="o">:</span> <span class="nx">oldHook</span> <span class="o">?</span> <span class="nx">oldHook</span><span class="p">.</span><span class="nx">state</span> <span class="o">:</span> <span class="nx">initial</span><span class="p">,</span>
        <span class="nx">queue</span><span class="o">:</span> <span class="p">[],</span> <span class="c1">// queueå­˜æ”¾setStateçš„å…¥å‚ï¼Œè¡¨ç¤ºä¸€ä¸ªä¿®æ”¹stateçš„å‡½æ•°
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="c1">// æ‰§è¡Œactions
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">actions</span> <span class="o">=</span> <span class="nx">oldHook</span> <span class="o">?</span> <span class="nx">oldHook</span><span class="p">.</span><span class="nx">queue</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="nx">actions</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">action</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">hook</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">action</span><span class="p">(</span><span class="nx">hook</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="kr">const</span> <span class="nx">setState</span> <span class="o">=</span> <span class="nx">action</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">hook</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">);</span>
        <span class="c1">// æµè§ˆå™¨ç©ºé—²æ—¶è¿›è¡Œé‡æ–°performUnitOfWork
</span><span class="c1"></span>        <span class="nx">wipRoot</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">dom</span><span class="o">:</span> <span class="nx">currentRoot</span><span class="p">.</span><span class="nx">dom</span><span class="p">,</span>
            <span class="nx">props</span><span class="o">:</span> <span class="nx">currentRoot</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
            <span class="nx">alternate</span><span class="o">:</span> <span class="nx">currentRoot</span>
        <span class="p">}</span>
        <span class="nx">nextUnitOfWork</span> <span class="o">=</span> <span class="nx">wipRoot</span><span class="p">;</span>
        <span class="nx">deletions</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
    <span class="nx">wipFiber</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">hook</span><span class="p">);</span>
    <span class="nx">hookIndex</span><span class="o">++</span><span class="p">;</span> <span class="c1">// hooksä¸€å®šè¦æœ‰é¡ºåº
</span><span class="c1"></span>    <span class="k">return</span> <span class="p">[</span><span class="nx">hook</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div><p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬è‡ªè¡Œå®ç°çš„ç‰ˆæœ¬çš„Reactå•¦ï¼
åœ¨çº¿ç‰ˆæœ¬ï¼šhttps://codesandbox.io/s/didact-8-21ost</p>
<h1 id="åè®°">åè®°</h1>
<p>Besides helping you understand how React works, one of the goals of this post is to make it easier for you to dive deeper in the React codebase. Thatâ€™s why we used the same variable and function names almost everywhere.</p>
<p>For example, if you add a breakpoint in one of your function components in a real React app, the call stack should show you:</p>
<ul>
<li>workLoop</li>
<li>performUnitOfWork</li>
<li>updateFunctionComponent</li>
</ul>
<p>We didnâ€™t include a lot of React features and optimizations. For example, these are a few things that React does differently:</p>
<ul>
<li>In Didact, we are walking the whole tree during the render phase. React instead follows some hints and heuristics to skip entire sub-trees where nothing changed.</li>
<li>We are also walking the whole tree in the commit phase. React keeps a linked list with just the fibers that have effects and only visit those fibers.</li>
<li>Every time we build a new work in progress tree, we create new objects for each fiber. React recycles the fibers from the previous trees.</li>
<li>When Didact receives a new update during the render phase, it throws away the work in progress tree and starts again from the root. React tags each update with an expiration timestamp and uses it to decide which update has a higher priority.</li>
<li>And many moreâ€¦</li>
</ul>
<p>There are also a few features that you can add easily:</p>
<ul>
<li>use an object for the style prop</li>
<li>flatten children arrays</li>
<li>useEffect hook</li>
<li>reconciliation by key</li>
</ul>
<p>If you add any of these or other features to Didact send a pull request to the GitHub repo, so others can see it.
<a href="https://github.com/pomber/didact">https://github.com/pomber/didact</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/ObzerverZQ.github.io/tags/react/">React</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>

    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>


    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>


    

    <footer class="site-footer">
    <section class="copyright">&copy; 2021 Observerçš„å°å®¶</section>
    <section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="1.1.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true" style="display:none">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"
    integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous"></script><script type="text/javascript" src="/ObzerverZQ.github.io/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<link rel="stylesheet" href="/ObzerverZQ.github.io/css/highlight/light.min.css" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="/ObzerverZQ.github.io/css/highlight/dark.min.css" media="(prefers-color-scheme: dark)">

    </body>
</html>
